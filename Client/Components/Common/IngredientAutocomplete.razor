@using BlazingRecept.Shared.Dto
@using BlazingRecept.Client.Services.Interfaces
@inject IIngredientSearchService IngredientSearchService
@implements IDisposable

<div class="ingredient-autocomplete">
    <input type="text" 
           class="form-control" 
           @ref="_inputElement"
           @bind-value="@SearchText" 
           @bind-value:event="oninput"
           @onfocus="HandleInputFocus"
           @onblur="HandleInputBlur"
           placeholder="@Placeholder"
           @attributes="AdditionalAttributes" />
    
    @if (_isSearching)
    {
        <div class="autocomplete-loading">
            <small class="text-muted">SÃ¶ker...</small>
        </div>
    }
    
    @if (_showResults && _searchResults.Count > 0)
    {
        <div class="autocomplete-results" @onmousedown:preventDefault="true">
            @foreach (var result in _searchResults)
            {
                <div class="autocomplete-item" @onclick="() => SelectResult(result)">
                    <div class="autocomplete-item-name">@result.Name</div>
                    <div class="autocomplete-item-macros">
                        <small class="text-muted">
                            Kcal: @result.Calories.ToString("F1") | 
                            F: @result.Fat.ToString("F1")g | 
                            K: @result.Carbohydrates.ToString("F1")g | 
                            P: @result.Protein.ToString("F1")g
                        </small>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private const int BlurDelayMs = 200; // Delay to allow click events on results to fire before blur closes the dropdown
    private const int DebounceDelayMs = 300; // Debounce delay to avoid excessive API calls
    
    private ElementReference _inputElement;
    private List<IngredientSearchResultDto> _searchResults = new();
    private bool _showResults = false;
    private bool _isSearching = false;
    private System.Threading.Timer? _debounceTimer;
    private string _searchText = string.Empty;

    [Parameter]
    public string SearchText 
    { 
        get => _searchText;
        set
        {
            if (_searchText != value)
            {
                _searchText = value;
                SearchTextChanged.InvokeAsync(value);
                DebounceSearch();
            }
        }
    }

    [Parameter]
    public EventCallback<string> SearchTextChanged { get; set; }

    [Parameter]
    public EventCallback<IngredientSearchResultDto> OnResultSelected { get; set; }

    [Parameter]
    public string Placeholder { get; set; } = "Ange ingrediensnamn";

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private void DebounceSearch()
    {
        _debounceTimer?.Dispose();
        _debounceTimer = new System.Threading.Timer(_ => PerformSearchSafe(), null, DebounceDelayMs, Timeout.Infinite);
    }

    private void PerformSearchSafe()
    {
        try
        {
            Task.Run(async () => await PerformSearch()).Wait();
        }
        catch (Exception ex)
        {
            // Log error but don't crash the component
            Console.WriteLine($"Error during ingredient search: {ex.Message}");
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(_searchText) || _searchText.Length < 2)
        {
            await InvokeAsync(() =>
            {
                _searchResults.Clear();
                _showResults = false;
                _isSearching = false;
                StateHasChanged();
            });
            return;
        }

        await InvokeAsync(() =>
        {
            _isSearching = true;
            StateHasChanged();
        });

        var results = await IngredientSearchService.SearchAsync(_searchText);

        await InvokeAsync(() =>
        {
            _searchResults = results.ToList();
            _showResults = true;
            _isSearching = false;
            StateHasChanged();
        });
    }

    private async Task SelectResult(IngredientSearchResultDto result)
    {
        _searchText = result.Name;
        _showResults = false;
        _searchResults.Clear();
        await SearchTextChanged.InvokeAsync(_searchText);
        await OnResultSelected.InvokeAsync(result);
        StateHasChanged();
    }

    private void HandleInputFocus()
    {
        if (_searchResults.Count > 0)
        {
            _showResults = true;
        }
    }

    private void HandleInputBlur()
    {
        // Use a small delay to allow click events to fire on the results
        Task.Delay(BlurDelayMs).ContinueWith(_ => 
        {
            InvokeAsync(() =>
            {
                _showResults = false;
                StateHasChanged();
            });
        });
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
